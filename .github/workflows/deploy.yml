# .github/workflows/deploy.yml - CI/CD com GitHub Actions

name: Deploy Braticargas

# Quando executar
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permite executar manualmente

# Vari√°veis de ambiente
env:
  NODE_VERSION: '18'

jobs:
  # Job 1: Testes e Build
  build:
    name: Build e Testes
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout do c√≥digo
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v3
      
      # 2. Configurar Node.js
      - name: üì¶ Configurar Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # 3. Instalar depend√™ncias
      - name: üì¶ Instalar depend√™ncias
        run: npm ci
      
      # 4. Executar linter (se configurado)
      - name: üîç Lint
        run: npm run lint --if-present
        continue-on-error: true
      
      # 5. Build
      - name: üèóÔ∏è Build
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_EMAIL_COOPERATIVA: ${{ secrets.VITE_EMAIL_COOPERATIVA }}
      
      # 6. Upload do build como artifact
      - name: üì§ Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: dist
          path: dist/
          retention-days: 1

  # Job 2: Deploy (s√≥ roda no push para main)
  deploy:
    name: Deploy para Produ√ß√£o
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      # 1. Download do build artifact
      - name: üì• Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: dist
          path: dist/
      
      # 2. Deploy para Vercel
      - name: üöÄ Deploy para Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
      
      # OU Deploy para VPS via SSH (alternativa)
      # - name: üöÄ Deploy para VPS
      #   uses: appleboy/scp-action@master
      #   with:
      #     host: ${{ secrets.VPS_HOST }}
      #     username: ${{ secrets.VPS_USERNAME }}
      #     key: ${{ secrets.VPS_SSH_KEY }}
      #     source: "dist/"
      #     target: "/var/www/braticargas/"
      # 
      # - name: üîÑ Restart Nginx
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.VPS_HOST }}
      #     username: ${{ secrets.VPS_USERNAME }}
      #     key: ${{ secrets.VPS_SSH_KEY }}
      #     script: |
      #       sudo systemctl reload nginx
      #       echo "Deploy conclu√≠do!"

  # Job 3: Notifica√ß√£o (opcional)
  notify:
    name: Notificar Deploy
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: üìß Notificar sucesso
        if: success()
        run: |
          echo "‚úÖ Deploy realizado com sucesso!"
          # Aqui voc√™ pode adicionar notifica√ß√£o por email, Slack, etc.
      
      - name: üìß Notificar falha
        if: failure()
        run: |
          echo "‚ùå Deploy falhou!"
          # Aqui voc√™ pode adicionar notifica√ß√£o de erro

# Configura√ß√£o de Secrets necess√°rios:
# 
# Para Vercel:
# - VERCEL_TOKEN: Token da Vercel (pegar em: https://vercel.com/account/tokens)
# - VERCEL_ORG_ID: ID da organiza√ß√£o (pegar em: https://vercel.com/teams/settings)
# - VERCEL_PROJECT_ID: ID do projeto (pegar no projeto ‚Üí Settings)
# - VITE_SUPABASE_URL: URL do Supabase
# - VITE_SUPABASE_ANON_KEY: Chave an√¥nima do Supabase
# - VITE_EMAIL_COOPERATIVA: Email da cooperativa
#
# Para VPS:
# - VPS_HOST: IP ou dom√≠nio do servidor
# - VPS_USERNAME: Usu√°rio SSH
# - VPS_SSH_KEY: Chave privada SSH
#
# Como adicionar secrets:
# 1. V√° em: https://github.com/seu-usuario/braticargas/settings/secrets/actions
# 2. Clique em "New repository secret"
# 3. Adicione cada secret acima
